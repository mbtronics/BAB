{% macro fullcalendar_content() %}

    <div id="error_msg"></div>
    <div id='calendar'></div>
    <div id="dialog" title="" style="display:none;">Are you sure want to delete it?</div>
{% endmacro %}

{% macro fullcalendar_scripts(type, resource, setdata, getdata, eventOverlap, selectConstraint, eventColor) %}
    <link rel='stylesheet' href='{{ url_for("static", filename="fullcalendar/fullcalendar.css") }}' />
    <script src='{{ url_for("static", filename="fullcalendar/fullcalendar.js") }}'></script>
    <script src='{{ url_for("static", filename="fullcalendar/lib/jquery-ui.custom.min.js") }}'></script>

    <link href='{{ url_for("static", filename="bootstrap-dialog/css/bootstrap-dialog.min.css") }}' rel="stylesheet" type="text/css" />
    <script src='{{ url_for("static", filename="bootstrap-dialog/js/bootstrap-dialog.min.js") }}'></script>

    <script>

        function isOverlapping(event) {
            var array = $('#calendar').fullCalendar('clientEvents');

            for(i in array) {
                if(array[i].id != event.id) {
                    if(!(array[i].start._d >= event.end._d || array[i].end._d <= event.start._d)) {
                        if (array[i].id!='available' && array[i].id!='reservation') {
                            return true;
                        }
                    }
                }
            }
            return false;
        }

        function showErrorMsg(msg) {
            $('#error_msg').html('<div class="container">'+
                                    '<div class="alert alert-warning">'+
                                        '<button type="button" class="close" data-dismiss="alert">&times;</button>'+
                                        msg+
                                    '</div>'+
                                '</div>');
        }

        function postEvent(action, event) {

            if (isOverlapping(event)) {
                $('#calendar').fullCalendar('refetchEvents');
                return;
            }

            var offset = new Date().getTimezoneOffset();
            var data = Object({ action: action,
                                id: event._id,
                                start: Math.round(event.start / 1000) ,
                                end: Math.round(event.end / 1000),
                                offset: offset,
                                reason: event.reason});

            $.ajax({
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                dataType: 'json',
                url: '{{ url_for(setdata, id=resource.id) }}',

                success: function(response) {

                    if (response.err) {
                        showErrorMsg(response.err);
                    } else if (response.id) {
                        event.id = response.id;
                        event._start = event.start;
                        $('#calendar').fullCalendar('updateEvent', event);
                    }
                    $('#calendar').fullCalendar('refetchEvents');
                },

                error: function(e) {
                    $('#calendar').fullCalendar('refetchEvents');
                }
            });
        }

        $(document).ready(function() {

            var duration = moment.utc( {{ resource.reserv_per }}*1000*60 ).format("HH:mm:ss");

            $('#calendar').fullCalendar({

                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek,agendaDay'
                },

                firstDay: 1,
                editable: true,
                weekends: true,
                slotDuration: duration,
                snapDuration: duration,
                defaultTimedEventDuration: duration,
                defaultView: 'agendaWeek',
                draggable: true,
                forceEventDuration: true,
                eventOverlap: {% if eventOverlap %}true{% else %}false{% endif %},
                scrollTime :  "13:00:00",
                slotLabelFormat: "HH:mm",
                timeFormat: "HH:mm",
                allDaySlot: false,
                columnFormat: 'ddd D/M',
                selectable: true,
                {% if selectConstraint %}
                    selectConstraint: '{{ selectConstraint }}',
                {% endif %}

                select: function(start, end, jsEvent, view) {
                    {% if type=='reservation' %}
                        var offset = new Date().getTimezoneOffset();
                        BootstrapDialog.show({
                            title: 'Reservation for {{ resource.name }}',
                            message: 'You are making a new reservation at '+ moment(start).format("MMM Do HH:mm")  +'.<br>What are you planning to do?<input type="text" class="form-control">',
                            closable: true,
                            draggable: true,
                            buttons: [{
                                        label: 'Save',
                                        action: function(dialogRef) {
                                            var reason = dialogRef.getModalBody().find('input').val();
                                            if (reason=='') {
                                                return false;
                                            }
                                            else {
                                                var NewEvent = Object({allDay: false, start: start, end: end, reason: reason});
                                                postEvent('new', NewEvent);
                                                dialogRef.close();
                                            }
                                        }
                                      }, {
                                        label: 'Cancel',
                                        action: function(dialogRef) {
                                            dialogRef.close();
                                        }
                            }]
                        });
                    {% else %}
                        var NewEvent = Object({allDay: false, start: start, end: end});
                        postEvent('new', NewEvent);
                    {% endif %}
                },

                eventClick: function(event, jsEvent, view) {

                    if (event.title!='Reserved') {
                        BootstrapDialog.confirm({
                            title: 'Remove ' + {% if type=='reservation' %}'reservation'{% endif %}
                            {% if type=='available' %}'timespan'{% endif %}+ '?',
                            message: moment(event.start).format('MMMM Do YYYY, HH:mm') + '<br>' + event.title,
                            type: BootstrapDialog.TYPE_WARNING,
                            closable: true,
                            draggable: true,
                            btnOKClass: 'btn-warning',
                            callback: function (result) {
                                if (result) {
                                    postEvent('remove', event)
                                }
                            }
                        });
                    }
                },

                eventResize: function( event, delta, revertFunc, jsEvent, ui, view ) {
                    postEvent('update', event);
                },

                eventDrop: function(event, delta, revertFunc) {
                    postEvent('update', event);
                },

                events: {
                    url: '{{ url_for(getdata, id=resource.id) }}',
                    color: '{{ eventColor }}',
                },

            })
        });
    </script>
{% endmacro %}