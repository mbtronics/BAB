{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block title %}{{ config['APP_NAME'] }} - Make payment for {{ user.username }}{% endblock %}

{% block page_content %}

<div class="col-md-12">
    <div class="page-header">
        <h1>Make payment for {{ user.name }} ({{ user.username }})</h1>
    </div>

    <form action="" method="post" class="form" role="form">
        <fieldset>
            <legend>Add Entries</legend>

            <div class="payment-row">
                <label>Type:</label>
                <select name="type[]" required onchange="typeChange(this);">
                    <option value="custom">custom</option>
                    <option value="reservation">reservation</option>
                    <option value="membership">membership</option>
                </select>

                <label>Reservation:</label>
                <select name="reservation[]" style="max-width:30%;" onchange="reservationChange(this);">
                        <option value="0"></option>
                    {% for reservation in user.reservations.all() %}
                        <option value="{{ reservation.id }}">{{ reservation.start }} ({{ reservation.reason }})</option>
                    {% endfor %}
                </select>

                <label>Description:</label>
                <input name="description[]" required size="30"/>

                <label>Amount:</label>
                <input type="float" name="amount[]" required style="width: 50px;" value="0"/>
            </div>
            <div id="end"></div>

            <br>
            <label>Method:</label>
            <select name="method" required>
                {% for method in methods %}
                    <option value="{{ method }}">{{ method }}</option>
                {% endfor %}
            </select>

            <br>
            <input class="btn btn-default" type="button" id="add-row" name="add-row" value="Add row" />
            <input class="btn btn-default" type="submit" value="Pay">

        </fieldset>
    </form>
</div>

{% endblock %}

{% block scripts %}

    {{ super() }}

    <script type="application/javascript">

        var reservations = [
            {% for reservation in user.reservations.all() %}
                {
                    'reason': '{{ reservation.reason }}',
                    'cost': {{ reservation.cost }}
                },
            {% endfor %}
        ];

        jQuery(function($){
            var button = $('#add-row');
            var row = $('.payment-row').clone();

            button.click(function(){
                row.clone().insertBefore($('#end'));
            });
        });

        function getElementIdInArray(element, type) {
            var rows = document.getElementsByName(type).length;
            var i = 0;
            for (i=0; i<rows; i++) {
                if (document.getElementsByName(type)[i]==element) {
                    return i
                }
            }
            return -1;
        }

        function typeChange(type) {
            var i = getElementIdInArray(type, 'type[]');

            document.getElementsByName('reservation[]')[i].value = 0;
            document.getElementsByName('amount[]')[i].value = 0;
            document.getElementsByName('description[]')[i].value = '';

            if (type.value=='membership') {
                document.getElementsByName('amount[]')[i].value = 12;
                document.getElementsByName('description[]')[i].value = 'Membership {{ user.name }}';
            }
        }

        function reservationChange(reservation) {
            var i = getElementIdInArray(reservation, 'reservation[]');
            var type = document.getElementsByName('type[]')[i].value;

            if (type=='reservation') {
                if (reservation.selectedIndex == 0) {
                    document.getElementsByName('description[]')[i].value = '';
                    document.getElementsByName('amount[]')[i].value = '';
                } else {
                    document.getElementsByName('description[]')[i].value = reservations[reservation.selectedIndex - 1]['reason'];
                    document.getElementsByName('amount[]')[i].value = reservations[reservation.selectedIndex - 1]['cost'];
                }
            } else {
                reservation.value = 0;
            }
        }

    </script>

{% endblock %}
